<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events &amp; Lifecycle â€” Pulse.js</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">
</head>
<body>
  <button class="menu-toggle" aria-label="Toggle menu">&#9776;</button>
  <aside class="sidebar"><div class="sidebar-brand"><h2>Pulse.js</h2><span class="version">v1.0.0</span></div><nav></nav></aside>

  <main class="content">
    <h1>Events &amp; Lifecycle</h1>
    <p>Pulse emits custom events at each stage of the request-response lifecycle. You can listen to these events to add custom behavior.</p>

    <h2 id="lifecycle">Lifecycle Flow</h2>

    <div class="flow-diagram">
      <div class="flow-step action">Trigger fires</div>
      <div class="flow-arrow"></div>
      <div class="flow-step cancelable">pulse:before</div>
      <div class="flow-label">cancelable</div>
      <div class="flow-arrow"></div>
      <div class="flow-step cancelable">pulse:beforeSend</div>
      <div class="flow-label">cancelable &mdash; request built</div>
      <div class="flow-arrow"></div>
      <div class="flow-step action">fetch()</div>
      <div class="flow-arrow"></div>
      <div class="flow-step cancelable">pulse:beforeSwap</div>
      <div class="flow-label">cancelable &mdash; response received</div>
      <div class="flow-arrow"></div>
      <div class="flow-step action">DOM swap</div>
      <div class="flow-arrow"></div>
      <div class="flow-step info">pulse:afterSwap</div>
      <div class="flow-arrow"></div>
      <div class="flow-step action">Settle (CSS classes)</div>
      <div class="flow-arrow"></div>
      <div class="flow-step info">pulse:afterSettle</div>
    </div>

    <div class="flow-diagram" style="margin-top:0">
      <div class="flow-branch-label">On error:</div>
      <div class="flow-step error">pulse:error</div>
    </div>

    <h2 id="events">All Events</h2>
    <table>
      <thead><tr><th>Event</th><th>Cancelable</th><th>When</th><th>Detail Properties</th></tr></thead>
      <tbody>
        <tr>
          <td><code>pulse:before</code></td>
          <td>Yes</td>
          <td>Before anything happens</td>
          <td><code>element</code>, <code>request</code></td>
        </tr>
        <tr>
          <td><code>pulse:beforeSend</code></td>
          <td>Yes</td>
          <td>After request is built, before fetch</td>
          <td><code>element</code>, <code>request</code></td>
        </tr>
        <tr>
          <td><code>pulse:beforeSwap</code></td>
          <td>Yes</td>
          <td>After response received, before DOM update</td>
          <td><code>element</code>, <code>request</code>, <code>response</code>, <code>target</code>, <code>content</code></td>
        </tr>
        <tr>
          <td><code>pulse:afterSwap</code></td>
          <td>No</td>
          <td>After DOM swap</td>
          <td><code>element</code>, <code>request</code>, <code>response</code>, <code>target</code></td>
        </tr>
        <tr>
          <td><code>pulse:afterSettle</code></td>
          <td>No</td>
          <td>After settle completes</td>
          <td><code>element</code>, <code>request</code>, <code>response</code>, <code>target</code></td>
        </tr>
        <tr>
          <td><code>pulse:error</code></td>
          <td>No</td>
          <td>On request error</td>
          <td><code>element</code>, <code>request</code>, <code>error</code></td>
        </tr>
        <tr>
          <td><code>pulse:ready</code></td>
          <td>No</td>
          <td>Pulse initialization complete</td>
          <td>(none)</td>
        </tr>
      </tbody>
    </table>

    <h2 id="listening-js">Listening via JavaScript</h2>
    <p>Events bubble up the DOM. You can listen on any ancestor, including <code>document</code>.</p>
<pre><code class="language-javascript">// Listen for all Pulse requests
document.addEventListener('pulse:before', (e) => {
  console.log('Request starting:', e.detail.request.parsed.url);
});

// Cancel a request conditionally
document.addEventListener('pulse:before', (e) => {
  if (!userIsLoggedIn()) {
    e.preventDefault(); // cancels the request
    showLoginModal();
  }
});

// React to errors
document.addEventListener('pulse:error', (e) => {
  showToast('Request failed: ' + e.detail.error.message);
});

// Listen on a specific element
const form = document.getElementById('myForm');
form.addEventListener('pulse:afterSwap', (e) => {
  form.reset();
});</code></pre>

    <h2 id="p-on">The p-on Attribute</h2>
    <p>Attach event handlers directly in HTML with <code>p-on</code>.</p>

    <h3 id="p-on-syntax">Syntax</h3>
<pre><code class="language-html">p-on="eventName: expression | eventName: expression"</code></pre>

    <h3 id="p-on-examples">Examples</h3>
<pre><code class="language-html">&lt;!-- Reset form after successful swap --&gt;
&lt;form p-request="POST /submit {this} > #result"
      p-on="pulse:afterSwap: this.reset()"&gt;
  ...
&lt;/form&gt;

&lt;!-- Show toast on error --&gt;
&lt;button p-request="POST /action > #result"
        p-on="pulse:error: alert('Something went wrong')"&gt;
  Act
&lt;/button&gt;

&lt;!-- Multiple handlers --&gt;
&lt;div p-request="GET /data > this"
     p-on="pulse:before: this.style.opacity = '0.5' | pulse:afterSwap: this.style.opacity = '1'"&gt;
  Content
&lt;/div&gt;

&lt;!-- Log everything --&gt;
&lt;div p-request="GET /data"
     p-on="pulse:before: console.log('before') | pulse:afterSwap: console.log('swapped') | pulse:error: console.error(event.detail.error)"&gt;
  Debug
&lt;/div&gt;</code></pre>

    <div class="note">In <code>p-on</code> expressions, <code>this</code> refers to the element and <code>event</code> refers to the CustomEvent object.</div>

    <h2 id="server-events">Server-Triggered Events</h2>
    <p>The server can trigger custom events on the client using response headers:</p>
<pre><code class="language-bash">// Server sends:
P-Trigger: showToast

// Or with data:
P-Trigger: {"showToast": {"message": "Saved!", "type": "success"}}</code></pre>
<pre><code class="language-javascript">// Client listens:
document.addEventListener('showToast', (e) => {
  displayToast(e.detail.message, e.detail.type);
});</code></pre>

    <p>Three timing variants:</p>
    <ul>
      <li><code>P-Trigger</code> &mdash; fires immediately when response is received</li>
      <li><code>P-Trigger-After-Swap</code> &mdash; fires after DOM swap</li>
      <li><code>P-Trigger-After-Settle</code> &mdash; fires after settle completes</li>
    </ul>

    <div class="page-nav">
      <a class="prev" href="examples.html">&larr; Examples</a>
      <a class="next" href="advanced.html">Advanced Topics &rarr;</a>
    </div>
  </main>
  <script src="nav.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js"></script>
</body>
</html>
